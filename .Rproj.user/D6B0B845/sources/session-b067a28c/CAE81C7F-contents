## Dendro WORK##

library(dplR)

#Remove
remove(ChildsCI)

#Data

Childs <- read.tucson('ChildsCol1.rwl')

plot(Childs, plot.type = "spag")

rwl.report(Childs)
summary(Childs)

#Detrend
Childs.rwi <- detrend(rwl= Childs, method = "AgeDepSpline")
rwi.stats(Childs.rwi)

#Mean-Value Chronology
Chron.crn <- chron(Childs.rwi)
plot(Chron.crn, add.spline = TRUE, nyrs = 5)

#Filtered for years with at least 4 samples
Filtered <-chron(detrend(Childs[ChildsChron.crn$samp.depth > 4,], 
              method="AgeDepSpline"))
plot(Filtered, add.spline = TRUE, nyrs = 10)

#Uncertainty

ChildsAve <- apply(Filtered, 1, mean, na.rm= TRUE)


CI <- chron.ci(Filtered, biweight = TRUE, R= 500, conf=.99)


dat <- data.frame(yrs=time(ChildsCI), ChildsCI)
ggplot(data=dat, mapping = aes(x=yrs)) +
  geom_hline(yintercept = 1,linetype="dashed") +
  geom_ribbon(aes(ymin=lowerCI,ymax=upperCI),
              alpha=0.5,fill="blue") +
  geom_line(aes(y=std),col="grey30") +
  labs(x="Year",y="RWI") + theme_minimal()

#Arstan chronology

ChildsArsCrn <- chron.ars(Chron.crn)
str(ChildsArsCrn)
ChildsArsCrn <- ChildsArsCrn[,3:4]

plot(ChildsArsCrn,add.spline = TRUE, nyrs = 5)




#BAI
BAI <- bai.in(Childs, d2pith= NULL)
BAI.rwi <- detrend(rwl= BAI, method = "AgeDepSpline")
#Detrend? Do I need to for BAI???
BAI.rwi <- detrend(rwl= BAI, method = "AgeDepSpline")
#Plot
BAIChron <- chron(BAI.rwi)
plot.crn(BAIChron, add.spline=TRUE, nyrs = 5, window(x=1980))

#XDatr/Cofecha

Childsseg <- corr.rwl.seg(Childs, seg.length = 4, pcrit= .2)


corr.series.seg(rwl = Childs, series= "C51", bin.floor = 2000, seg.length = 6)


xskel.ccf.plot(rwl = Childs, series = "C38", win.start =2000, win.width = 20)


summary.rwl(Childs)




